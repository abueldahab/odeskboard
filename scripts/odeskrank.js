// Generated by CoffeeScript 1.6.3
(function() {
  "use strict";
  var cycle, jquery, lodash, main, phantom, _;

  phantom = require("phantom");

  _ = require('lodash');

  jquery = "http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js";

  lodash = "//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js";

  cycle = 40000;

  main = function(page) {
    var callback, find, getPagesCount, oDeskRun, onLoad;
    onLoad = function(callback) {
      return function() {
        var getFreelancersNames, onError;
        getFreelancersNames = function() {
          var arr;
          arr = [];
          $("h2 span[itemprop='name']").each(function() {
            return arr.push($(this).html());
          });
          return arr;
        };
        onError = function(result) {
          return console.log(result);
        };
        return setTimeout(function() {
          /* Evaluate after ajax render
          */

          var names;
          names = page.evaluate(getFreelancersNames, onError);
          return callback(names);
        }, cycle);
      };
    };
    getPagesCount = function() {
      var count, pagination;
      pagination = $('nav.oPagination');
      count = '0';
      if (pagination) {
        count = pagination.first().find('li a').last().attr('href').split('page=')[1];
      }
      return parseInt(count, 10);
    };
    oDeskRun = function(callback, keyword, pagesLimit) {
      var allFreelancers, done, loopFn, oDeskurl, pageIndex;
      if (keyword == null) {
        keyword = 'angularjs';
      }
      if (pagesLimit == null) {
        pagesLimit = 2;
      }
      pageIndex = 0;
      allFreelancers = {};
      loopFn = function() {
        var currentIndex, oDeskurl, singlePageCallback;
        if (pageIndex++ > pagesLimit) {
          return;
        }
        currentIndex = pageIndex;
        oDeskurl = "https://www.odesk.com/o/profiles/browse/?q=" + keyword;
        if (pageIndex > 1) {
          oDeskurl += "&page=" + pageIndex;
        }
        console.log(oDeskurl);
        singlePageCallback = function(names) {
          var i, name, rank, _i, _len;
          if (names) {
            for (i = _i = 0, _len = names.length; _i < _len; i = ++_i) {
              name = names[i];
              rank = (i + 1) + (currentIndex * names.length);
              allFreelancers[name] = rank;
              console.log("Adding " + name + " with rank " + rank);
            }
          }
          return done();
        };
        return page.open(oDeskurl, function(status) {
          return page.injectJs(jquery, onLoad(singlePageCallback));
        });
      };
      oDeskurl = "https://www.odesk.com/o/profiles/browse/?q=" + keyword;
      page.open(oDeskurl, function(status) {
        return page.injectJs(jquery, function() {
          return setTimeout(function() {
            var count;
            count = getPagesCount();
            pagesLimit = count;
            return console.log("Going to search in " + count + " pages.");
          }, cycle);
        });
      });
      return done = _.after(pagesLimit, function() {
        clearInterval(interval);
        console.log(allFreelancers);
        return callback(allFreelancers);
      });
    };
    find = function(name, list) {
      var freelancer, rank;
      for (freelancer in list) {
        rank = list[freelancer];
        if (freelancer.indexOf(name) >= 0) {
          return rank;
        }
      }
      return -1;
    };
    callback = function(list) {
      var rank;
      rank = find('Diaa', list);
      console.log(list);
      return console.log("You Are indexed : " + rank);
    };
    return oDeskRun(callback);
  };

  phantom.create(function(ph) {
    return ph.createPage(main);
  });

}).call(this);

/*
//@ sourceMappingURL=odeskrank.map
*/
